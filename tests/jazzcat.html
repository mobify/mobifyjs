<!DOCTYPE html>
<html class="foo">
<head>
  <meta charset="utf-8">
  <title>jazzcat.js Tests</title>
  <link rel="stylesheet" href="/tests/resources/qunit-1.10.0.css">
  <script src="/tests/resources/qunit-1.10.0.js"></script>
  <script src="/tests/resources/require.js" id="requirejs"></script>
  <script src="/tests/resources/jquery-1.7.1.js"></script>
</head>
<body>

<div id="qunit"></div>


<!-- Fixtures -->

<div id="qunit-fixture"></div>

<textarea id="insertLoaderIntoHTMLString">
    <script x-src="http://cached/"></script>
    <script x-src="http://uncached/"></script>
</textarea>

<!-- Fixtures for ensuring `combineScripts` executes scripts in the right order. -->
<textarea id="combineScripts-source">
    <script>var a = window.a = ['a']</script>
    <script x-src="http://should.be/cached/push-b.js"></script>
    <script>a.push('c')</script>
    <script x-src="http://should.be/cached/push-d.js"></script>
</textarea>

<textarea id="combineScripts-loader">
    <script src="/build/mobify.js"></script>
    <script>
        Jazzcat.httpCache.load();
        var scripts = document.getElementsByTagName("textarea")[0].textContent;
        document.write(scripts);
        parent.postMessage(a, "*");
    </script>
</textarea>

<textarea id="combineScripts-coldcache-source">
    <script x-src="/tests/resources/jquery-1.7.1.js"></script>
</textarea>

<textarea id="combineScripts-coldcache-loader">
    <script src="/build/mobify.js"></script>
    <script>
        Jazzcat.httpCache.load();
        var scripts = document.getElementsByTagName("textarea")[0].textContent;
        document.write(scripts);
        document.write('<script>parent.postMessage(!!window.jQuery, "*");<\/script>');
    </script>
</textarea>

<textarea id="test-jazzcat-combo-exec">
    /*</script>*/
    "</script>"
    /</script>/
</textarea>

<textarea id="test-jazzcat-combo-exec-document-write-override">
    <script src="/build/mobify.js"></script>
    <script>
        document.write = function() {
            parent.postMessage(false, "*");
        };

        Jazzcat.combo.load([{
            "url": "cached",
            "status": "ready",
            "statusCode": 200,
            "text": true,
            "body": "parent.postMessage(true, '*');"
        }]);
        Jazzcat.combo.exec('cached');
    </script>
</textarea>

<!-- Tests -->
<script>
    QUnit.config.autostart = false;
    require.config({"baseUrl": "../src/"});
    require(["capture", "jazzcat", "utils"], function(Capture, Jazzcat, Utils) {
        QUnit.start();

        var httpCache = Jazzcat.httpCache;

        // Time offsets in seconds.
        var TWO_WEEKS = 14 * 24 * 60 * 60;
        var FOUR_WEEKS = 2 * TWO_WEEKS;
        var TEN_MINUTES = 600;

        // UTC dates.
        var UTC_TWO_WEEKS_FROM_NOW = (new Date(Date.now() + (TWO_WEEKS * 1000))).toUTCString();
        var UTC_TWO_WEEKS_AGO = (new Date(Date.now() - (TWO_WEEKS * 1000))).toUTCString();
        var UTC_NOW = (new Date()).toUTCString();
        var UTC_BEGINNING_OF_TIME = (new Date(0)).toUTCString();

        var resourceFixtures = {
            'stale-expires': {
                'headers': {
                    'date': UTC_TWO_WEEKS_AGO,
                    'expires': UTC_TWO_WEEKS_AGO
                }
            },
            'stale-cache-control': {
                'headers': {
                    'date': UTC_TWO_WEEKS_AGO,
                    'cache-control': 'public,max-age=' + TEN_MINUTES
                }
            },
            'fresh-expires': {'headers': {'expires': UTC_TWO_WEEKS_FROM_NOW}},
            'fresh-cache-control': {
                'headers': {
                    'date': UTC_NOW,
                    'cache-control': 'public,max-age=' + TEN_MINUTES
                }
            },
            'old-fresh-cache-control': {
                'headers': {
                    'date': UTC_TWO_WEEKS_AGO,
                    'cache-control': 'public,max-age=' + FOUR_WEEKS
                }
            },
            'no-headers': {'headers': {}},
            'undefined-headers': {},
            'invalid-date': {
                'headers': {
                    'date': 'invalid',
                    'cache-control': 'public,max-age=' + TEN_MINUTES
                }
            },
            'invalid-expires': {'headers': {'expires': 'invalid'}},
            'uncacheable': {
                'headers': {
                    'date': UTC_NOW,
                    'cache-control': 'no-cache'
                }
            },
            'new-no-cache-headers': {
                'headers': {
                    'date': UTC_NOW
                }
            },
            'old-no-cache-headers': {
                'headers': {
                    'date': UTC_TWO_WEEKS_AGO
                }
            },
        };

        // Too big for localStorage in Chrome, Webkit, and Firefox
        var LONG_STRING = Array(10000000).join('1');

        // Fix <\/script>.
        // Remove extra whitespace.
        var getText = function(selector) {
            return $(selector).val()
                              .replace(/\\/g, '')
                              .replace(/\s+/g, ' ')
                              .trim();
        };

        asyncTest('httpCache - Eviction on an unused resource', 2, function() {
            httpCache.reset();
            httpCache.save();

            httpCache.set('unused', {'headers': {'expires': UTC_TWO_WEEKS_FROM_NOW}, body: LONG_STRING})
            httpCache.set('used', {'headers': {'expires': UTC_TWO_WEEKS_FROM_NOW}, body: 'used'})
            httpCache.get('used', true)

            httpCache.save(function(err) {
                if (err) throw err;

                httpCache.reset();
                httpCache.load();

                ok(!httpCache.get('unused'), '`unused` was evicted');
                ok(!!httpCache.get('used'), '`used` was cached');

                start();
            });
        });

        asyncTest('httpCache - Least recently used eviction', 2, function() {
            httpCache.reset();
            httpCache.save();

            httpCache.set('old', {'headers': {'expires': UTC_TWO_WEEKS_FROM_NOW}, body: LONG_STRING})
            httpCache.get('old', true)

            setTimeout(function() {
                httpCache.set('new', {'headers': {'expires': UTC_TWO_WEEKS_FROM_NOW}, body: 'new'})
                httpCache.get('new', true)

                httpCache.save(function(err) {
                    if (err) throw err;

                    httpCache.reset();
                    httpCache.load();

                    ok(!httpCache.get('old'), '`old` was evicted');
                    ok(!!httpCache.get('new'), '`new` was cached');

                    start();
                });
            }, 0);
        });

        test('httpCache.utils.isStale', 8, function() {
            var isStale = httpCache.utils.isStale;


            ok(isStale(resourceFixtures['stale-expires']));
            ok(isStale(resourceFixtures['stale-cache-control']));
            ok(!isStale(resourceFixtures['fresh-expires']));
            ok(!isStale(resourceFixtures['fresh-cache-control']));
            ok(isStale(resourceFixtures['no-headers']),
              'No cache headers is stale');
            ok(isStale(resourceFixtures['undefined-headers']),
              'undefined cache headers is stale');
            ok(isStale(resourceFixtures['invalid-date']),
              'Invalid date is stale');
            ok(isStale(resourceFixtures['invalid-expires']),
              'Invalid expires is stale');
        });

        test('isStale with cacheOverride', function() {
            var isStale = httpCache.utils.isStale;
            var staleOptions = {overrideTime: 10};

            // should be fresh
            ok(!isStale(resourceFixtures['new-no-cache-headers'], staleOptions),
              'fresh with no cache headers');
            ok(!isStale(resourceFixtures['fresh-cache-control'], staleOptions),
              'fresh with new response');
            ok(!isStale(resourceFixtures['uncacheable'], staleOptions),
              'fresh with otherwise uncacheable fresh response');

            // should be stale
            ok(isStale(resourceFixtures['old-no-cache-headers'], staleOptions),
              'stale old response');
            ok(isStale(resourceFixtures['old-fresh-cache-control'], staleOptions),
              'stale old response with fresh cache-control');
            ok(isStale(resourceFixtures['stale-expires'], staleOptions),
              'stale old response with expires');
            ok(isStale(resourceFixtures['stale-cache-control'], staleOptions),
              'stale old response with cache control');
            ok(isStale(resourceFixtures['undefined-headers'], staleOptions),
              'stale with no headers');
            ok(isStale(resourceFixtures['invalid-expires'], staleOptions),
              'stale with no date header and invalid expires');
        });

        asyncTest('combineScripts - Warm cache', 1, function() {
            httpCache.reset({
                'http://should.be/cached/push-b.js': {
                    'headers': {'expires': UTC_TWO_WEEKS_FROM_NOW},
                    'status': 'ready',
                    'url': 'http://should.be/cached/push-b.js',
                    'body': 'window.a.push("b")',
                    'text': true
                },
                'http://should.be/cached/push-d.js': {
                    'headers': {'expires': UTC_TWO_WEEKS_FROM_NOW},
                    'status': 'ready',
                    'url': 'http://should.be/cached/push-d.js',
                    'body': 'window.a.push("d")',
                    'text': true
                }
            });

            var scripts = $($("#combineScripts-source").text()).filter("script").toArray();
            var results = Jazzcat.combineScripts(scripts);

            httpCache.save(function(err) {
                if (err) throw err;

                // Setup "Capturing" like execution phase.
                var html = '';
                html += "<textarea>" + results.map(function(el) {
                    return el.outerHTML + "\n";
                }).join("") + "</textarea>";
                html += $('#combineScripts-loader').text();
                html = '<html><body>' + html + '</body></html>';

                // `contentWindow` is attached once the iframe is in the document.
                var $iframe = $('<iframe>').appendTo('#qunit-fixture');
                var el = $iframe[0];

                $(window).one("message", function(event) {
                    event = event.originalEvent;
                    if (event.source != el.contentWindow) return;
                    deepEqual(event.data, ['a', 'b', 'c', 'd'], 'a = [a, b, c , d]');
                    start();
                });

                el.contentDocument.open();
                el.contentDocument.write(html);
                el.contentDocument.close();
            });
        });

        asyncTest('combineScripts - Cold cache', 1, function() {
            var scripts = $($("#combineScripts-coldcache-source").text()).filter("script").toArray();
            var results = Jazzcat.combineScripts(scripts);

            var html = '';
            html += "<textarea>" + results.map(function(el) {
                    return el.outerHTML + "\n";
                }).join("") + "</textarea>";
            html += $('#combineScripts-coldcache-loader').text();
            html = '<html><body>' + html + '</body></html>';

            var $iframe = $('<iframe>').appendTo('#qunit-fixture');
            var el = $iframe[0];

            $(window).one("message", function(event) {
                event = event.originalEvent;
                if (event.source != el.contentWindow) return;
                ok(event.data, 'jQuery was loaded');
                start();
            });

            el.contentDocument.open();
            el.contentDocument.write(html);
            el.contentDocument.close();
        });

        asyncTest('combineScripts - override cache time', function() {
            var checkFreshPresent = function() {
                // override cache time to 10 minutes
                Jazzcat.combineScripts([], {cacheOverrideTime: 10});
                ok(false);
                //run checkStaleAbsent
                //resourceFixtures['new-no-cache-headers']
                httpCache.reset({})
                httpCache.save(checkStaleAbsent);
            };
            var checkStaleAbsent = function() {
                // disable override
                Jazzcat.combineScripts([], {cacheOverrideTime: false});
                ok(false);
                //resourceFixtures['new-no-cache-headers']
                httpCache.reset({});
                httpCache.save(start);
            };

            httpCache.reset({});
            httpCache.save(checkFreshPresent);
        });

        asyncTest('insertLoaderIntoHTMLString', 1, function() {
            httpCache.reset({
                'http://cached/': {
                    'headers': {'expires': UTC_TWO_WEEKS_FROM_NOW},
                    'status': 'ready',
                    'body': 'cached',
                    'text': true
                }
            });

            httpCache.save(function() {
                var scripts = $($("#insertLoaderIntoHTMLString").text()).filter("script").toArray();
                Jazzcat.combineScripts(scripts);

                var html = scripts.reduce(function(html, script) {
                    return html + Utils.outerHTML(script);
                }, '')

                var result = Jazzcat.insertLoaderIntoHTMLString(html);
                var expected = '<script src="//jazzcat.mobify.com/jsonp/Jazzcat.combo.load/%5B%22http%3A%2F%2Funcached%2F%22%5D"><\/script><script>true,Jazzcat.combo.exec(\'http://cached/\');<\/script><script>false,Jazzcat.combo.exec(\'http://uncached/\');<\/script>';
                equal(result, expected, "Loader inserted successfully")
                start();
            });
        })

        asyncTest('Jazzcat.combo.load - Encoded Urls are cached', 1, function() {
            var url = "http://127.0.0.1:3000/space invaders.js";
            var resources = [{
                "url": url,
                "headers": {"expires": UTC_TWO_WEEKS_FROM_NOW},
                "status": "ready",
                "statusCode": 200,
                "text": true,
                "body": "console.log('Pew!');"
            }];

            httpCache.reset();
            httpCache.save(function(err) {
                if (err) throw err;

                Jazzcat.combo.load(resources);
                ok(httpCache.get(encodeURI(url)) != undefined, "Missing resource.");
                start();
            });
        });

        test('getUrl - generates urls with project parameter', function() {
            // No projectName set
            var urls = [
                "//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js",
                "//ajax.googleapis.com/ajax/libs/angularjs/1.0.5/angular.min.js"
            ];
            var callback = "foo";
            var expected = "//jazzcat.mobify.com/jsonp/foo/%5B%22%2F%2Fajax.googleapis.com%2Fajax%2Flibs%2Fangularjs%2F1.0.5%2Fangular.min.js%22%2C%22%2F%2Fajax.googleapis.com%2Fajax%2Flibs%2Fjquery%2F1.9.1%2Fjquery.min.js%22%5D";

            equal(Jazzcat.getURL(urls, callback), expected);

            // projectName qux
            try {
                Jazzcat.combineScripts.defaults.projectName = "qux";
                callback = "bar";
                expected = "//jazzcat.mobify.com/project-qux/jsonp/bar/%5B%22%2F%2Fajax.googleapis.com%2Fajax%2Flibs%2Fangularjs%2F1.0.5%2Fangular.min.js%22%2C%22%2F%2Fajax.googleapis.com%2Fajax%2Flibs%2Fjquery%2F1.9.1%2Fjquery.min.js%22%5D";

                equal(Jazzcat.getURL(urls, callback), expected);
            // Reset projectName
            } finally {
                Jazzcat.combineScripts.defaults.projectName = ""
            }
        });

        test('Jazzcat.combo.exec - writes scripts as expected', 3, function() {
            httpCache.reset({
                'cached': {
                    'headers': {'expires': UTC_TWO_WEEKS_FROM_NOW},
                    'status': 'ready',
                    'url': 'cached',
                    'body': 'cached',
                    'text': true
                },
                'cached-with-scripts': {
                    'headers': {'expires': UTC_TWO_WEEKS_FROM_NOW},
                    'status': 'ready',
                    'url': 'cached-with-scripts',
                    'body': getText("#test-jazzcat-combo-exec"),
                    'text': true
                }
            });


            var origWrite = Jazzcat.write
            var result;

            Jazzcat.write = function(s) {
                result = s;
            }

            try {
                Jazzcat.combo.exec('uncached');
                equal(result, '<script src="uncached"><\/script>');

                Jazzcat.combo.exec('cached');
                equal(result, '<script data-orig-src="cached">cached<\/script>');

                Jazzcat.combo.exec('cached-with-scripts');
                equal(result, '<script data-orig-src=\"cached-with-scripts\">/*<\/scr\\ipt>*/ \"<\/scr\\ipt>\" \/<\/scr\\ipt>\/<\/script>');
            } finally {
                Jazzcat.write = origWrite;
            }
        });

        asyncTest('Jazzcat.combo.exec - test document.write override', function() {
            var html = $("#test-jazzcat-combo-exec-document-write-override").val();

            var $iframe = $('<iframe>').appendTo('#qunit-fixture');
            var el = $iframe[0];

            $(window).one("message", function(event) {
                event = event.originalEvent;
                if (event.source != el.contentWindow) return;
                ok(event.data, 'document.write was overriden');
                start();
            });

            el.contentDocument.open();
            el.contentDocument.write(html);
            el.contentDocument.close();
        });
    });
</script>
</body>
</html>